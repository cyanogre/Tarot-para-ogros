<!DOCTYPE html>
<html lang="es">
<head>
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-9443552615965258"
     crossorigin="anonymous"></script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="google-adsense-account" content="ca-pub-9443552615965258">
    <title>üîÆ Tarot de Grum el Ogro azul üîÆ</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&display=swap');
        @import url('https://fonts.googleapis.com/css2?family=Cormorant+Garamond:wght@400;700&display=swap');

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Cormorant Garamond', serif;
            background: radial-gradient(circle, #0a011a 0%, #000000 100%);
            color: #f0f0f0;
            min-height: 100vh;
            overflow: hidden; 
        }

        ::-webkit-scrollbar {
            width: 10px;
        }
        ::-webkit-scrollbar-track {
            background: #0a011a;
        }
        ::-webkit-scrollbar-thumb {
            background-color: #c0a87a;
            border-radius: 20px;
            border: 2px solid #0a011a;
        }
        ::-webkit-scrollbar-thumb:hover {
            background-color: #e6c88e;
        }

        .stars {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 1;
        }

        .star {
            position: absolute;
            background: linear-gradient(to bottom, #f0e6d2, #a09070);
            border-radius: 50%;
            box-shadow: 0 0 5px #f0e6d2;
            animation: twinkle 3s infinite alternate;
        }

        @keyframes twinkle {
            0% { opacity: 0.3; transform: scale(0.8); }
            100% { opacity: 1; transform: scale(1.2); }
        }
        
        .shooting-star {
            position: absolute;
            height: 2px;
            background: linear-gradient(-45deg, #e6c88e, rgba(0, 0, 255, 0));
            border-radius: 999px;
            filter: drop-shadow(0 0 6px #e6c88e);
            animation: tail 3s ease-in-out infinite, shooting 3s ease-in-out infinite;
        }

        @keyframes tail {
            0% { width: 0; }
            30% { width: 100px; }
            100% { width: 0; }
        }

        @keyframes shooting {
            0% { transform: translateX(0); }
            100% { transform: translateX(100vw); }
        }

        .container {
            position: relative;
            z-index: 10;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            height: 100vh;
            overflow-y: auto;
        }

        .header {
            text-align: center;
            margin-top: 60px;
            margin-bottom: 20px;
            animation: fadeInDown 1s ease-out;
        }

        .header h1 {
            font-family: 'Cinzel', serif;
            font-size: 3.5rem;
            color: #c0a87a;
            text-shadow: 0 0 15px rgba(255, 215, 0, 0.4);
            margin-bottom: 10px;
        }
        
        .header p {
            font-size: 1.2rem;
            color: #b8b8b8;
        }

        .ogre-area {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 20px;
            flex-wrap: wrap;
            min-height: 170px;
        }

        .speech-bubble {
            position: relative;
            background: rgba(16, 8, 32, 0.6);
            backdrop-filter: blur(10px);
            border-radius: 1em;
            padding: 20px;
            max-width: 400px;
            text-align: left;
            border: 2px solid #c0a87a;
            box-shadow: 0 0 15px rgba(192, 168, 122, 0.3);
            display: none;
        }

        .speech-bubble:after {
            content: '';
            position: absolute;
            left: 0;
            top: 50%;
            width: 0;
            height: 0;
            border: 20px solid transparent;
            border-right-color: #c0a87a;
            border-left: 0;
            border-bottom: 0;
            margin-top: -10px;
            margin-left: -20px;
        }

        @keyframes fadeInDown {
            0% { opacity: 0; transform: translateY(-30px); }
            100% { opacity: 1; transform: translateY(0); }
        }

        .controls {
            display: flex;
            gap: 20px;
            justify-content: center;
            flex-wrap: wrap;
            margin-bottom: 40px;
            animation: fadeInUp 1s ease-out 0.3s both;
        }

        @keyframes fadeInUp {
            0% { opacity: 0; transform: translateY(30px); }
            100% { opacity: 1; transform: translateY(0); }
        }

        .control-group {
            background: rgba(16, 8, 32, 0.4);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 20px;
            border: 2px solid #c0a87a;
            box-shadow: 0 0 10px rgba(192, 168, 122, 0.2);
            transition: all 0.3s ease;
        }

        .control-group:hover {
            border-color: #e6c88e;
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(192, 168, 122, 0.4);
        }

        .control-group h3 {
            color: #e6c88e;
            margin-bottom: 10px;
            font-size: 1.2rem;
            text-transform: uppercase;
            font-family: 'Cinzel', serif;
        }

        select, button {
            background: rgba(0, 0, 0, 0.5);
            color: #f0f0f0;
            border: 2px solid #c0a87a;
            border-radius: 8px;
            padding: 10px 15px;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.3s ease;
            font-family: 'Cormorant Garamond', serif;
        }

        button {
            background: linear-gradient(45deg, #c0a87a, #e6c88e);
            color: #1e0c3a;
            font-weight: bold;
            text-transform: uppercase;
            letter-spacing: 1px;
            position: relative;
            overflow: hidden;
            border: none;
            box-shadow: 0 5px 15px rgba(192, 168, 122, 0.4);
        }

        button:before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.4), transparent);
            transition: left 0.5s;
        }

        button:hover:before {
            left: 100%;
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(192, 168, 122, 0.6);
        }

        button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            box-shadow: none;
        }

        .deck-area {
            text-align: center;
            margin: 40px 0;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            padding-bottom: 30px; /* Espacio para el texto de abajo */
        }
        
        /* --- EL "ESCENARIO" FIJO PARA LA ANIMACI√ìN --- */
        .deck-wrapper {
            position: relative;
            width: 120px;
            height: 180px;
            perspective: 1000px;
            margin-bottom: 15px;
        }

        #shuffling-container, .deck {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
        }

        .shuffling-container {
            transform-style: preserve-3d;
        }

        .shuffling-card {
            position: absolute;
            width: 120px;
            height: 180px;
            background: linear-gradient(135deg, #1e0c3a, #2d1b69);
            border-radius: 12px;
            border: 3px solid #c0a87a;
            transition: transform 1s, opacity 1s;
            backface-visibility: hidden;
        }

        .deck {
            cursor: pointer;
            transition: transform 0.3s ease;
        }
        
        .deck:hover {
            transform: scale(1.05);
        }

        .card-back {
            position: absolute;
            width: 120px;
            height: 180px;
            background: linear-gradient(135deg, #1e0c3a, #2d1b69);
            border-radius: 12px;
            border: 3px solid #c0a87a;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2rem;
            transition: all 0.5s ease;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.5);
        }

        .card-back::after {
            content: 'üîÆ';
            font-size: 3rem;
            opacity: 0.8;
            text-shadow: 0 0 10px #e6c88e;
        }

        .deck .card-back:nth-child(1) { transform: rotate(-2deg) translate(2px, -2px); }
        .deck .card-back:nth-child(2) { transform: rotate(1deg) translate(-1px, 1px); }
        .deck .card-back:nth-child(3) { transform: rotate(-1deg) translate(1px, -1px); }

        .reading-area {
            min-height: 220px; 
            margin-top: 20px;
            animation: fadeIn 1s ease-out;
        }

        @keyframes fadeIn {
            0% { opacity: 0; }
            100% { opacity: 1; }
        }

        .spread-container {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 20px;
            margin-top: 40px;
        }

        .card {
            width: 120px;
            height: 180px;
            background: linear-gradient(135deg, #f8f8f8, #e8e8e8);
            border-radius: 12px;
            border: 3px solid #c0a87a;
            position: relative;
            cursor: pointer;
            transition: all 0.5s ease;
            transform-style: preserve-3d;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.4);
        }

        .card.flipping {
            animation: flip 1s ease-in-out forwards;
        }

        @keyframes flip {
            0% { transform: rotateY(180deg); }
            100% { transform: rotateY(0deg); }
        }

        .card.revealed {
            transform: rotateY(0deg);
        }

        .card.inverted {
            transform: rotateY(0deg) rotate(180deg);
        }

        .card.revealed.inverted {
            transform: rotateY(0deg) rotate(180deg);
        }

        .card:hover {
            transform: translateY(-10px) scale(1.05);
            box-shadow: 0 15px 35px rgba(192, 168, 122, 0.5);
        }

        .card-content {
            padding: 10px;
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            text-align: center;
            color: #2c1810;
            font-weight: bold;
            background: linear-gradient(135deg, #fff, #f0f0f0);
            border-radius: 9px;
            position: relative;
        }

        .card-name {
            font-size: 0.8rem;
            margin-bottom: 5px;
            color: #8b4513;
            line-height: 1.1;
        }

        .card-symbol {
            font-size: 2.8rem;
            margin: 5px 0;
        }

        .card-orientation {
            font-size: 0.75rem;
            color: #666;
            font-style: italic;
        }

        .card-position {
            position: absolute;
            top: -30px;
            left: 50%;
            transform: translateX(-50%);
            background: #c0a87a;
            color: #1e0c3a;
            padding: 5px 12px;
            border-radius: 15px;
            font-size: 0.8rem;
            font-weight: bold;
            white-space: nowrap;
        }

        .results {
            background: rgba(16, 8, 32, 0.4);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 30px;
            margin: 40px 0;
            border: 2px solid #c0a87a;
            box-shadow: 0 0 20px rgba(192, 168, 122, 0.2);
            animation: slideInUp 0.8s ease-out;
        }

        @keyframes slideInUp {
            0% { opacity: 0; transform: translateY(50px); }
            100% { opacity: 1; transform: translateY(0); }
        }

        .results h2 {
            font-family: 'Cinzel', serif;
            color: #e6c88e;
            text-align: center;
            margin-bottom: 20px;
            font-size: 1.8rem;
        }

        .result-item {
            margin: 15px 0;
            padding: 15px;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 10px;
            border-left: 4px solid #e6c88e;
        }

        .result-item h3 {
            color: #e6c88e;
            margin-bottom: 5px;
        }

        .result-item h4 {
            color: #f0f0f0;
            margin-bottom: 10px;
        }

        .result-item p {
            color: #e0e0e0;
            font-style: italic;
        }

        .export-btn {
            background: linear-gradient(45deg, #6c4675, #9c6c94);
            color: #fff;
        }

        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255,255,255,0.3);
            border-radius: 50%;
            border-top-color: #fff;
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .mystical-particles {
            position: absolute;
            width: 100%;
            height: 100%;
            pointer-events: none;
            overflow: hidden;
        }

        .particle {
            position: absolute;
            width: 4px;
            height: 4px;
            background: radial-gradient(circle, #e6c88e, #c0a87a);
            border-radius: 50%;
            box-shadow: 0 0 5px #e6c88e;
            animation: float 5s infinite ease-in-out;
            opacity: 0.7;
        }

        @keyframes float {
            0%, 100% { transform: translateY(0px) rotate(0deg); opacity: 0.7; }
            50% { transform: translateY(-50px) rotate(180deg); opacity: 0.9; }
        }

        .music-controls {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 100;
        }

        .music-controls button {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(5px);
            border: 1px solid rgba(255, 255, 255, 0.4);
            color: #fff;
            font-size: 1rem;
            padding: 8px 12px;
            border-radius: 50px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .music-controls button:hover {
            background: rgba(255, 255, 255, 0.2);
        }
        
        .privacy-button {
            position: fixed;
            bottom: 20px;
            left: 20px;
            z-index: 999;
            background: rgba(16, 8, 32, 0.6);
            backdrop-filter: blur(10px);
            border: 1px solid #c0a87a;
            color: #e6c88e;
            width: 45px;
            height: 45px;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            font-size: 1.5rem;
            transition: all 0.3s ease;
        }

        .privacy-button:hover {
            background: rgba(30, 12, 58, 0.8);
            transform: scale(1.1);
        }


        .cookie-banner {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            background: rgba(10, 5, 25, 0.9);
            backdrop-filter: blur(10px);
            padding: 20px;
            z-index: 1000;
            display: flex;
            justify-content: center;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
            border-top: 1px solid rgba(192, 168, 122, 0.5);
            transform: translateY(100%);
            animation: slideUpBanner 0.5s ease-out forwards;
        }

        @keyframes slideUpBanner {
            to { transform: translateY(0); }
        }

        .cookie-banner p {
            margin: 0;
            flex-grow: 1;
            text-align: center;
            color: #e0e0e0;
        }
        .cookie-banner p a {
            color: #e6c88e;
            text-decoration: underline;
        }
        .cookie-banner .cookie-buttons {
            display: flex;
            gap: 10px;
        }

        .cookie-banner button {
            padding: 8px 16px;
            border-radius: 5px;
        }
        #cookie-accept {
            background: #c0a87a;
            color: #1e0c3a;
            border-color: #c0a87a;
        }
        #cookie-decline {
            background: transparent;
            color: #f0f0f0;
            border-color: #f0f0f0;
        }

        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(5px);
            z-index: 1001;
            display: none;
            justify-content: center;
            align-items: center;
        }

        .modal-content {
            background: #1e0c3a;
            padding: 30px;
            border-radius: 15px;
            border: 2px solid #c0a87a;
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            position: relative;
        }

        .modal-content h2 { color: #e6c88e; margin-bottom: 15px; }
        .modal-content p, .modal-content ul { margin-bottom: 15px; line-height: 1.6; }
        .modal-content ul { padding-left: 20px; }
        .modal-close {
            position: absolute;
            top: 15px;
            right: 15px;
            background: none;
            border: none;
            color: #fff;
            font-size: 1.5rem;
            cursor: pointer;
        }

        @media (max-width: 768px) {
            .header h1 { font-size: 2.5rem; }
            .controls { flex-direction: column; align-items: center; }
            .card { width: 100px; height: 150px; }
            .spread-container { gap: 15px; }
            .card-symbol { font-size: 2rem; }
            .ogre-area { flex-direction: column; }
            .speech-bubble::after {
                top: auto; 
                content: '';
                position: absolute;
                bottom: 100%;
                left: 50%;
                margin-left: -20px;
                width: 0;
                height: 0;
                border: 20px solid transparent;
                border-bottom-color: #c0a87a;
            }
            .cookie-banner {
                flex-direction: column;
            }
        }

        @keyframes spin-and-return {
            0% { transform: rotateY(0deg) scale(1); }
            50% { transform: rotateY(360deg) scale(1.05); }
            100% { transform: rotateY(720deg) scale(1); }
        }

        .card.spinning {
            animation: spin-and-return 1s ease-in-out;
        }

        .card.card--major-arcana .card-content {
            background: radial-gradient(circle, #001d57 0%, #000814 100%);
            color: #f0f0f0;
            position: relative;
            overflow: hidden; 
        }
        
        .card.card--major-arcana .card-name {
            color: #e6c88e;
            font-family: 'Cinzel', serif;
        }
        
        .card.card--major-arcana .card-symbol {
            color: #e6c88e;
            text-shadow: 0 0 10px #e6c88e, 0 0 20px #e6c88e, 0 0 30px #e6c88e;
        }

        .card.card--major-arcana .card-orientation {
            color: #f0e6d2;
        }
        
        .card.card--major-arcana .card-content::after {
            content: '';
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            background: linear-gradient(
                115deg,
                transparent 20%,
                rgba(193, 222, 255, 0.4) 46%,
                rgba(255, 187, 220, 0.4) 50%,
                rgba(215, 255, 201, 0.4) 54%,
                transparent 80%
            );
            background-repeat: no-repeat;
            background-size: 250% 250%;
            opacity: 0.5; 
            transition: opacity 0.4s ease-in-out;
            pointer-events: none;
            animation: foil-shimmer 2.5s ease-in-out infinite;
        }
        
        @keyframes foil-shimmer {
            0% { background-position: 150% 150%; }
            100% { background-position: -50% -50%; }
        }
        
        .card.card--major-arcana:hover .card-content::after {
            opacity: 0.8; 
        }
        .main-nav {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 100;
            background: rgba(16, 8, 32, 0.6);
            backdrop-filter: blur(10px);
            padding: 10px 20px;
            border-radius: 50px;
            border: 1px solid #c0a87a;
            display: flex;
            gap: 20px;
        }
        .main-nav a {
            color: #e6c88e;
            text-decoration: none;
            font-family: 'Cinzel', serif;
            transition: all 0.3s ease;
        }
        .main-nav a:hover {
            color: #fff;
            text-shadow: 0 0 5px #fff;
        }
        @media (max-width: 768px) {
            .main-nav {
                gap: 10px;
                padding: 8px 15px;
                font-size: 0.8rem;
            }
        }
    </style>
</head>
<body>
    <div class="stars" id="stars"></div>
    <div class="mystical-particles" id="particles"></div>
    
    <div class="music-controls">
        <button id="muteBtn" onclick="toggleMute()">
            üîä Sonido
        </button>
    </div>
    <div class="main-nav">
        <a href="index.html">Tirada</a>
        <a href="sobre.html">Sobre Grum</a>
        <a href="tarot.html">¬øQu√© es el Tarot?</a>
        <a href="contacto.html">Contacto</a>
    </div>
    <div class="container">
        <div id="reading-snapshot">
            <div class="header">
                <h1>üîÆ Tarot de Grum el ogro azul ‚ú®</h1>
                <p>Descubre los secretos que las cartas de este ogro tienen para ti</p>
                <div class="ogre-area">
                    <img id="ogre-image" src="Ogro.png" alt="Ogro" style="max-width: 150px; height: auto;">
                    <div class="speech-bubble" id="ogre-interpretation">
                        El Ogro espera tu tirada...
                    </div>
                </div>
            </div>

            <div class="reading-area">
                <div class="spread-container" id="spreadContainer">
                </div>
            </div>

            <div class="results" id="results" style="display: none;">
                <h2>üìú Tu Lectura de Tarot</h2>
                <div id="resultsContent"></div>
            </div>
        </div>

        <div class="controls">
            <div class="control-group">
                <h3>Tipo de Mazo</h3>
                <select id="deckType">
                    <option value="full">Mazo Completo (78 cartas)</option>
                    <option value="major">Solo Arcanos Mayores (22 cartas)</option>
                </select>
            </div>

            <div class="control-group">
                <h3>Tipo de Tirada</h3>
                <select id="spreadType">
                    <option value="1">1 Carta (Respuesta)</option>
                    <option value="3">3 Cartas (Pasado, Presente, Futuro)</option>
                    <option value="5">5 Cartas (Cruz Simple)</option>
                    <option value="10">10 Cartas (Cruz Celta)</option>
                </select>
            </div>

            <div class="control-group">
                <button id="shuffleBtn" onclick="startReading()">
                    üîÆ Realizar Tirada
                </button>
                <button id="exportBtn" onclick="exportReading()" style="display: none;" class="export-btn">
                    üì∏ Exportar PNG
                </button>
            </div>
        </div>

        <div class="deck-area" id="deck-area">
            <div class="deck-wrapper">
                <div id="shuffling-container" class="shuffling-container" style="display: none;"></div>
                <div class="deck" id="deck" onclick="startReading()">
                    <div class="card-back"></div>
                    <div class="card-back"></div>
                    <div class="card-back"></div>
                </div>
            </div>
            <p id="deckStatus">Haz clic para comenzar tu lectura...</p>
        </div>
    </div>

    <div id="privacy-policy-link" class="privacy-button">üç™</div>

    <div id="cookie-banner" class="cookie-banner" style="display: none;">
        <p>Este sitio web utiliza cookies de an√°lisis para mejorar tu experiencia. ¬øAceptas su uso? Puedes consultar nuestra <a href="#" id="privacy-link-banner">pol√≠tica de privacidad</a>.</p>
        <div class="cookie-buttons">
            <button id="cookie-accept">Aceptar</button>
            <button id="cookie-decline">Rechazar</button>
        </div>
    </div>

    <div id="privacy-modal" class="modal-overlay">
        <div class="modal-content">
            <button id="modal-close" class="modal-close">&times;</button>
            <h2>Pol√≠tica de Privacidad y Cookies</h2>
            <p><strong>√öltima actualizaci√≥n:</strong> 19 de septiembre de 2025</p>
            <p>En Tarot del Ogro Azul, tu privacidad es importante. Esta pol√≠tica explica qu√© informaci√≥n recopilamos y c√≥mo la usamos.</p>
            <h3>Cookies</h3>
            <p>Una cookie es un peque√±o fichero que se almacena en tu ordenador. Usamos cookies para las siguientes finalidades:</p>
            <ul>
                <li><strong>Cookies de An√°lisis (Google Analytics):</strong> Utilizamos estas cookies para entender c√≥mo interact√∫as con nuestra web (qu√© tiradas son m√°s populares, cu√°nto tiempo pasas aqu√≠, etc.). Esta informaci√≥n es an√≥nima y nos ayuda a mejorar la aplicaci√≥n. Estas cookies solo se activar√°n si nos das tu consentimiento expl√≠cito.</li>
                <li><strong>Cookies de Preferencia:</strong> Usamos el almacenamiento local (LocalStorage) para guardar tu decisi√≥n sobre las cookies y evitar preguntarte de nuevo. Esto es una cookie t√©cnica y esencial.</li>
            </ul>
            <h3>Informaci√≥n enviada a Terceros</h3>
            <p>Para la interpretaci√≥n del Ogro, la informaci√≥n de tu tirada (los nombres de las cartas y sus posiciones) se env√≠a de forma an√≥nima a la API de Google Gemini para generar el texto. No se env√≠a ninguna informaci√≥n personal tuya.</p>
            <h3>Tu Consentimiento</h3>
            <p>Al hacer clic en "Aceptar" en el banner de cookies, nos das permiso para usar las cookies de an√°lisis. Si haces clic en "Rechazar", estas cookies no se usar√°n. Puedes cambiar de opini√≥n en cualquier momento borrando las cookies de tu navegador.</p>
        </div>
    </div>

    <script>
        const COOKIE_CONSENT_KEY = 'cookie_consent_ogre_tarot';

        function checkCookieConsent() {
            const consent = localStorage.getItem(COOKIE_CONSENT_KEY);
            if (consent === 'granted') {
                loadGoogleAnalytics();
            } else if (consent !== 'denied') {
                document.getElementById('cookie-banner').style.display = 'flex';
            }
        }

        function handleCookieConsent(consent) {
            localStorage.setItem(COOKIE_CONSENT_KEY, consent);
            document.getElementById('cookie-banner').style.display = 'none';
            if (consent === 'granted') {
                loadGoogleAnalytics();
            }
        }

        document.getElementById('cookie-accept').addEventListener('click', () => handleCookieConsent('granted'));
        document.getElementById('cookie-decline').addEventListener('click', () => handleCookieConsent('denied'));

        const privacyModal = document.getElementById('privacy-modal');
        const openModalLink = document.getElementById('privacy-policy-link');
        const openModalLinkBanner = document.getElementById('privacy-link-banner');
        const closeModalBtn = document.getElementById('modal-close');

        function openPrivacyModal(e) {
            e.preventDefault();
            privacyModal.style.display = 'flex';
        }
        
        openModalLink.addEventListener('click', openPrivacyModal);
        openModalLinkBanner.addEventListener('click', openPrivacyModal);
        closeModalBtn.addEventListener('click', () => privacyModal.style.display = 'none');
        privacyModal.addEventListener('click', (e) => {
            if (e.target === privacyModal) {
                privacyModal.style.display = 'none';
            }
        });

        const PROXY_URL = '/.netlify/functions/api-proxy';

        const MAJOR_ARCANA = [
            { name: "El Loco", symbol: "üÉè", type: "major" },
            { name: "El Mago", symbol: "üé©", type: "major" },
            { name: "La Sacerdotisa", symbol: "üëë", type: "major" },
            { name: "La Emperatriz", symbol: "üë∏", type: "major" },
            { name: "El Emperador", symbol: "üëë", type: "major" },
            { name: "El Hierofante", symbol: "‚õ™", type: "major" },
            { name: "Los Enamorados", symbol: "üíï", type: "major" },
            { name: "El Carro", symbol: "üèá", type: "major" },
            { name: "La Justicia", symbol: "‚öñÔ∏è", type: "major" },
            { name: "El Ermita√±o", symbol: "üïØÔ∏è", type: "major" },
            { name: "La Fortuna", symbol: "üé°", type: "major" },
            { name: "La Fuerza", symbol: "ü¶Å", type: "major" },
            { name: "El Colgado", symbol: "üôÉ", type: "major" },
            { name: "La Muerte", symbol: "üíÄ", type: "major" },
            { name: "La Templanza", symbol: "üç∑", type: "major" },
            { name: "El Diablo", symbol: "üòà", type: "major" },
            { name: "La Torre", symbol: "üè∞", type: "major" },
            { name: "La Estrella", symbol: "‚≠ê", type: "major" },
            { name: "La Luna", symbol: "üåô", type: "major" },
            { name: "El Sol", symbol: "‚òÄÔ∏è", type: "major" },
            { name: "El Juicio", symbol: "üìØ", type: "major" },
            { name: "El Mundo", symbol: "üåç", type: "major" }
        ];

        const SUITS = {
            'Copas': { symbol: 'üèÜ', color: '#4169e1', element: 'agua', theme: 'emociones, relaciones, intuici√≥n' },
            'Espadas': { symbol: '‚öîÔ∏è', color: '#c0392b', element: 'aire', theme: 'mente, conflictos, verdad' },
            'Bastos': { symbol: 'üèπ', color: '#8b4513', element: 'fuego', theme: 'energ√≠a, acci√≥n, creatividad' },
            'Oros': { symbol: 'ü™ô', color: '#ffd700', element: 'tierra', theme: 'materia, trabajo, recursos' }
        };

        const COURT_CARDS = ['Sota', 'Caballero', 'Reina', 'Rey'];
        
        const INTERPRETATIONS = {
            "El Loco": { keyword: "Inicio", upright: "Nuevos comienzos, espontaneidad, aventura, fe en el futuro. Es momento de dar un salto de fe.", reversed: "Imprudencia, falta de direcci√≥n, decisiones precipitadas. Necesitas m√°s planificaci√≥n." },
            "El Mago": { keyword: "Acci√≥n", upright: "Poder personal, manifestaci√≥n, recursos disponibles. Tienes todo lo que necesitas para triunfar.", reversed: "Manipulaci√≥n, falta de energ√≠a, recursos desperdiciados. Revisa tus intenciones." },
            "La Sacerdotisa": { keyword: "Intuici√≥n", upright: "Sabidur√≠a interior, misterios, intuici√≥n, conocimiento oculto. Conf√≠a en tu voz interior.", reversed: "Secretos revelados, falta de intuici√≥n, conocimiento superficial. Necesitas profundizar m√°s." },
            "La Emperatriz": { keyword: "Creaci√≥n", upright: "Fertilidad, creatividad, abundancia, naturaleza maternal. Es tiempo de crear y nutrir.", reversed: "Dependencia, creatividad bloqueada, falta de crecimiento. Reconecta con tu poder creativo." },
            "El Emperador": { keyword: "Orden", upright: "Autoridad, estructura, control, liderazgo. Toma las riendas de tu situaci√≥n.", reversed: "Tiran√≠a, falta de disciplina, abuso de poder. Necesitas equilibrar control y flexibilidad." },
            "El Hierofante": { keyword: "Tradici√≥n", upright: "Ense√±anzas tradicionales, conformidad, instituciones. Busca guidance en la sabidur√≠a establecida.", reversed: "Rebeld√≠a, nuevas formas, cuestionamiento de normas. Es hora de forjar tu propio camino." },
            "Los Enamorados": { keyword: "Elecci√≥n", upright: "Amor, relaciones, decisiones importantes, valores personales. Una elecci√≥n crucial te espera.", reversed: "Desamor, malas decisiones, valores en conflicto. Reflexiona antes de elegir." },
            "El Carro": { keyword: "Voluntad", upright: "Triunfo, determinaci√≥n, control, avance. Tu fuerza de voluntad te llevar√° al √©xito.", reversed: "Falta de direcci√≥n, p√©rdida de control, agresividad. Necesitas enfocar tu energ√≠a." },
            "La Justicia": { keyword: "Equilibrio", upright: "Justicia, equilibrio, verdad, responsabilidad. Las consecuencias de tus actos se manifiestan.", reversed: "Injusticia, desequilibrio, falta de responsabilidad. Busca la equidad en tus decisiones." },
            "El Ermita√±o": { keyword: "B√∫squeda", upright: "B√∫squeda interior, soledad constructiva, gu√≠a espiritual. Es tiempo de introspecci√≥n.", reversed: "Aislamiento, terquedad, rechazo de consejos. No te cierres a la ayuda externa." },
            "La Fortuna": { keyword: "Cambio", upright: "Cambios, ciclos, destino, buena suerte. Los vientos del cambio soplan a tu favor.", reversed: "Mala suerte, resistencia al cambio, ciclos negativos. Acepta que todo es temporal." },
            "La Fuerza": { keyword: "Dominio", upright: "Fuerza interior, valor, paciencia, autocontrol. Tu verdadera fuerza viene de dentro.", reversed: "Debilidad, falta de autocontrol, miedo. Reconecta con tu poder interior." },
            "El Colgado": { keyword: "Rendici√≥n", upright: "Sacrificio, nueva perspectiva, pausa, rendici√≥n. A veces hay que ceder para avanzar.", reversed: "Martirio, resistencia in√∫til, retrasos. Deja de luchar contra lo inevitable." },
            "La Muerte": { keyword: "Transformaci√≥n", upright: "Final de ciclos, transformaci√≥n, renacimiento. Un cap√≠tulo termina, otro comienza.", reversed: "Resistencia al cambio, estancamiento, miedo a la transformaci√≥n. Abraza el cambio necesario." },
            "La Templanza": { keyword: "Armon√≠a", upright: "Moderaci√≥n, equilibrio, paciencia, curaci√≥n. Encuentra el punto medio en todo.", reversed: "Impaciencia, extremos, falta de equilibrio. Necesitas m√°s moderaci√≥n." },
            "El Diablo": { keyword: "Atadura", upright: "Tentaci√≥n, ataduras, materialismo, adicciones. Examina qu√© te tiene prisionero.", reversed: "Liberaci√≥n, ruptura de cadenas, superaci√≥n de adicciones. Te est√°s liberando." },
            "La Torre": { keyword: "Ruptura", upright: "Cambio s√∫bito, revelaci√≥n, destrucci√≥n necesaria. Las falsas estructuras se derrumban.", reversed: "Evitar el cambio, cat√°strofe personal, resistencia. El cambio es inevitable." },
            "La Estrella": { keyword: "Esperanza", upright: "Esperanza, inspiraci√≥n, curaci√≥n, gu√≠a espiritual. La luz brilla al final del t√∫nel.", reversed: "Desesperanza, falta de fe, desconexi√≥n espiritual. Recupera tu fe interior." },
            "La Luna": { keyword: "Inconsciente", upright: "Ilusiones, subconsciente, miedos, intuici√≥n. No todo es lo que parece ser.", reversed: "Claridad, superaci√≥n de miedos, verdad revelada. La confusi√≥n se disipa." },
            "El Sol": { keyword: "Vitalidad", upright: "√âxito, vitalidad, positividad, claridad. Todo se ilumina en tu vida.", reversed: "Falta de energ√≠a, optimismo forzado, retrasos en el √©xito. Recupera tu vitalidad." },
            "El Juicio": { keyword: "Despertar", upright: "Despertar, llamada superior, renovaci√≥n, perd√≥n. Es hora de un nuevo amanecer.", reversed: "Falta de perd√≥n, juicio severo, llamada ignorada. Escucha tu voz interior." },
            "El Mundo": { keyword: "Culminaci√≥n", upright: "Logro, culminaci√≥n, viaje completado, integraci√≥n. Has alcan√ßado tu meta.", reversed: "Falta de cierre, objetivos incompletos, retrasos. Te falta poco para completar el ciclo." }
        };

        const MINOR_INTERPRETATIONS = {
            "Bastos": {
                "As": { keyword: "Impulso", upright: "Nuevo proyecto, inspiraci√≥n creativa, potencial energ√©tico.", reversed: "Falta de direcci√≥n, energ√≠a desperdiciada, proyectos fallidos." },
                "2": { keyword: "Decisi√≥n", upright: "Planificaci√≥n personal, decisiones futuras, dominio.", reversed: "Falta de planificaci√≥n, impaciencia, decisiones apresuradas." },
                "3": { keyword: "Expansi√≥n", upright: "Expansi√≥n, previsi√≥n, liderazgo comercial.", reversed: "Falta de previsi√≥n, retrasos, expansi√≥n fallida." },
                "4": { keyword: "Estabilidad", upright: "Celebraci√≥n, armon√≠a, hogar estable, logros.", reversed: "Falta de armon√≠a, problemas dom√©sticos, logros incompletos." },
                "5": { keyword: "Conflicto", upright: "Competencia, conflicto, lucha, desacuerdo.", reversed: "Evitar conflictos, competencia desleal, conflictos internos." },
                "6": { keyword: "Victoria", upright: "Victoria, reconocimiento p√∫blico, progreso, liderazgo.", reversed: "Victoria p√≠rrica, falta de reconocimiento, retrasos en el √©xito." },
                "7": { keyword: "Defensa", upright: "Defensa de posici√≥n, perseverancia, competencia.", reversed: "Ceder terreno, falta de perseverancia, sentirse abrumado." },
                "8": { keyword: "Movimiento", upright: "Movimiento r√°pido, progreso acelerado, noticias.", reversed: "Retrasos, frustraci√≥n, movimiento errado." },
                "9": { keyword: "Resistencia", upright: "Resistencia, persistencia, √∫ltima defensa.", reversed: "Rigidez, paranoia, falta de flexibilidad." },
                "10": { keyword: "Carga", upright: "Carga pesada, responsabilidad, opresi√≥n, pero cerca del final.", reversed: "Liberaci√≥n de cargas, delegaci√≥n, soltar responsabilidades." },
                "Sota": { keyword: "Aprendizaje ardiente", upright: "Mensajero entusiasta, nuevas oportunidades de aprendizaje.", reversed: "Inmadurez, impulsividad, mensajes confusos." },
                "Caballero": { keyword: "Movimiento ardiente", upright: "Aventura, impulsividad, viajes, acci√≥n r√°pida.", reversed: "Impaciencia, agresividad, cambios bruscos." },
                "Reina": { keyword: "Madurez ardiente", upright: "Confianza, determinaci√≥n, independencia, liderazgo femenino.", reversed: "Venganza, celos, manipulaci√≥n." },
                "Rey": { keyword: "Dominio ardiente", upright: "Liderazgo natural, visi√≥n emprendedora, honestidad.", reversed: "Tiran√≠a, impulsividad, liderazgo irresponsable." }
            },
            "Copas": {
                "As": { keyword: "Sentimiento", upright: "Nuevo amor, felicidad emocional, intuici√≥n, espiritualidad.", reversed: "Amor bloqueado, emociones reprimidas, vac√≠o espiritual." },
                "2": { keyword: "Uni√≥n", upright: "Asociaci√≥n, amor mutuo, uni√≥n, armon√≠a.", reversed: "Desamor, separaci√≥n, relaciones rotas." },
                "3": { keyword: "Celebraci√≥n", upright: "Celebraci√≥n, amistad, creatividad, comunidad.", reversed: "Aislamiento, creatividad bloqueada, p√©rdida de amistades." },
                "4": { keyword: "Aburrimiento", upright: "Apat√≠a, meditaci√≥n, reevaluaci√≥n, aburrimiento.", reversed: "Motivaci√≥n renovada, nuevas oportunidades, acci√≥n." },
                "5": { keyword: "P√©rdida", upright: "P√©rdida emocional, lamento, duelo, decepci√≥n.", reversed: "Recuperaci√≥n, aceptaci√≥n, movimiento despu√©s de la p√©rdida." },
                "6": { keyword: "Recuerdo", upright: "Nostalgia, recuerdos del pasado, inocencia, regalos.", reversed: "Vivir en el pasado, negaci√≥n del presente." },
                "7": { keyword: "Ilusi√≥n", upright: "Ilusiones, sue√±os, opciones fantasiosas, imaginaci√≥n.", reversed: "Realidad, claridad, determinaci√≥n, opciones reales." },
                "8": { keyword: "B√∫squeda", upright: "Abandono, b√∫squeda de algo superior, cambio emocional.", reversed: "Regresar, renovaci√≥n emocional, encontrar lo buscado." },
                "9": { keyword: "Plenitud", upright: "Satisfacci√≥n, felicidad, realizaci√≥n de deseos.", reversed: "Insatisfacci√≥n, arrogancia, deseos superficiales." },
                "10": { keyword: "Amor pleno", upright: "Felicidad familiar, amor verdadero, armon√≠a emocional.", reversed: "Familia disfuncional, valores perdidos, armon√≠a rota." },
                "Sota": { keyword: "Aprendizaje emocional", upright: "Mensaje de amor, estudio art√≠stico, sensibilidad.", reversed: "Inmadurez emocional, mensaje confuso, bloqueo creativo." },
                "Caballero": { keyword: "Movimiento emocional", upright: "Romance, invitaciones, proposiciones, charm.", reversed: "Moralidad cuestionable, promesas vac√≠as, enga√±o." },
                "Reina": { keyword: "Madurez emocional", upright: "Intuici√≥n, compasi√≥n, seguridad emocional, calidez.", reversed: "Dependencia emocional, manipulaci√≥n, inestabilidad." },
                "Rey": { keyword: "Dominio emocional", upright: "Equilibrio emocional, compasi√≥n, control, diplomacia.", reversed: "Volatilidad emocional, manipulaci√≥n, doble moral." }
            },
            "Espadas": {
                "As": { keyword: "Idea", upright: "Nueva idea, claridad mental, verdad, justicia.", reversed: "Confusi√≥n, ideas nubradas, injusticia." },
                "2": { keyword: "Duda", upright: "Decisi√≥n dif√≠cil, equilibrio tenso, estancamiento.", reversed: "Decisi√≥n tomada, fin del estancamiento, claridad." },
                "3": { keyword: "Dolor", upright: "Dolor de coraz√≥n, traici√≥n, separaci√≥n, pena.", reversed: "Recuperaci√≥n del dolor, perd√≥n, curaci√≥n emocional." },
                "4": { keyword: "Reposo", upright: "Descanso, meditaci√≥n, recuperaci√≥n, pausa.", reversed: "Agotamiento, insomnio, retorno a la actividad." },
                "5": { keyword: "Derrota", upright: "Derrota, humillaci√≥n, p√©rdida, conflicto.", reversed: "Recuperaci√≥n de la derrota, lecciones aprendidas." },
                "6": { keyword: "Tr√°nsito", upright: "Transici√≥n, viaje, cambio de estado, progreso.", reversed: "Resistencia al cambio, viaje cancelado, estancamiento." },
                "7": { keyword: "Estrategia", upright: "Estrategia, cautela, planificaci√≥n, escape.", reversed: "Confrontaci√≥n directa, estrategia fallida, ser descubierto." },
                "8": { keyword: "Atadura", upright: "Restricci√≥n, victimizaci√≥n, limitaciones, prisi√≥n.", reversed: "Liberaci√≥n, auto-empoderamiento, escape." },
                "9": { keyword: "Ansiedad", upright: "Ansiedad, pesadillas, culpa, depresi√≥n.", reversed: "Esperanza, curaci√≥n mental, liberaci√≥n de la ansiedad." },
                "10": { keyword: "Ruina", upright: "Ruina, final doloroso, traici√≥n, colapso.", reversed: "Recuperaci√≥n, nuevo amanecer, resistencia." },
                "Sota": { keyword: "Aprendizaje mental", upright: "Vigilancia, nuevas ideas, curiosidad, mensaje.", reversed: "Chismorreo, imprudencia, mal uso de informaci√≥n." },
                "Caballero": { keyword: "Movimiento mental", upright: "Acci√≥n impulsiva, valor, cambios bruscos.", reversed: "Imprudencia, falta de direcci√≥n, caos." },
                "Reina": { keyword: "Madurez mental", upright: "Independencia, perspicacia, experiencia, claridad.", reversed: "Crueldad, venganza, amargura." },
                "Rey": { keyword: "Dominio mental", upright: "Autoridad intelectual, verdad, juicio claro.", reversed: "Tiran√≠a, crueldad, abuso de poder." }
            },
            "Oros": {
                "As": { keyword: "Oportunidad", upright: "Nueva oportunidad financiera, prosperidad, manifestaci√≥n.", reversed: "Oportunidad perdida, codicia, materialismo." },
                "2": { keyword: "Equilibrio", upright: "Balance, adaptabilidad, gesti√≥n de tiempo y dinero.", reversed: "Desequilibrio, mala gesti√≥n, sobrecarga." },
                "3": { keyword: "Crecimiento", upright: "Trabajo en equipo, habilidad, construcci√≥n.", reversed: "Falta de trabajo en equipo, mediocridad, falta de visi√≥n." },
                "4": { keyword: "Avaricia", upright: "Seguridad, conservaci√≥n, posesividad, control.", reversed: "Generosidad, gastos, p√©rdida de control." },
                "5": { keyword: "Carencia", upright: "Problemas financieros, pobreza, aislamiento.", reversed: "Recuperaci√≥n financiera, ayuda, mejora." },
                "6": { keyword: "Generosidad", upright: "Generosidad, caridad, compartir, reciprocidad.", reversed: "Ego√≠smo, deuda, strings attached." },
                "7": { keyword: "Espera", upright: "Evaluaci√≥n, paciencia, recompensa a largo plazo.", reversed: "Impaciencia, falta de recompensa, trabajo sin frutos." },
                "8": { keyword: "Dedicaci√≥n", upright: "Artesan√≠a, habilidad, trabajo duro, dedicaci√≥n.", reversed: "Falta de atenci√≥n, trabajo de mala calidad, falta de pasi√≥n." },
                "9": { keyword: "Logro", upright: "Logro personal, lujo, independencia financiera.", reversed: "Dependencia, p√©rdida de logros, vac√≠o material." },
                "10": { keyword: "Prosperidad", upright: "Riqueza, herencia, familia, legado, seguridad.", reversed: "P√©rdida financiera, problemas familiares, inestabilidad." },
                "Sota": { keyword: "Aprendizaje material", upright: "Oportunidad de estudio, mensaje sobre dinero, manifestaci√≥n.", reversed: "Falta de concentraci√≥n, mensajes sobre p√©rdidas." },
                "Caballero": { keyword: "Movimiento material", upright: "Eficiencia, trabajo duro, responsabilidad.", reversed: "Pereza, falta de compromiso, trabajo incompleto." },
                "Reina": { keyword: "Madurez material", upright: "Practicidad, seguridad, generosidad, abundancia.", reversed: "Codicia, inseguridad, desconfianza." },
                "Rey": { keyword: "Dominio material", upright: "√âxito financiero, liderazgo empresarial, generosidad.", reversed: "Avaricia, corrupci√≥n, materialismo excesivo." }
            }
        };

        let currentDeck = [];
        let currentReading = [];
        let isReading = false;
        
        let audioCtx;
        let intervalId;
        let ambientMasterGain;
        let audioUnlocked = false;
        
        const notas = [261.63, 293.66, 311.13, 349.23, 392.00, 440.00, 466.16, 523.25];
        let isMuted = false;
        
        function playClickSound() {
            if (isMuted) return;
            setupAudio();
            const clickOsc = audioCtx.createOscillator();
            const clickGain = audioCtx.createGain();
            clickOsc.type = 'sine';
            clickOsc.frequency.setValueAtTime(440, audioCtx.currentTime);
            clickGain.gain.setValueAtTime(0.2, audioCtx.currentTime);
            clickGain.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + 0.1);
            clickOsc.connect(clickGain);
            clickGain.connect(audioCtx.destination);
            clickOsc.start(audioCtx.currentTime);
            clickOsc.stop(audioCtx.currentTime + 0.1);
        }

        function playCardRevealSound() {
            if (isMuted) return;
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            osc.type = 'triangle';
            osc.frequency.setValueAtTime(500, audioCtx.currentTime);
            gain.gain.setValueAtTime(0.3, audioCtx.currentTime);
            gain.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + 0.5);
            osc.connect(gain);
            gain.connect(audioCtx.destination);
            osc.start(audioCtx.currentTime);
            osc.stop(audioCtx.currentTime + 0.5);
        }
        
        function playShuffleSound() {
            if (isMuted) return;
            setupAudio();
            const shuffleBuffer = audioCtx.createBuffer(1, audioCtx.sampleRate * 2, audioCtx.sampleRate);
            const shuffleData = shuffleBuffer.getChannelData(0);
            for (let i = 0; i < shuffleData.length; i++) {
                shuffleData[i] = (Math.random() - 0.5) * 0.1;
            }
            const source = audioCtx.createBufferSource();
            source.buffer = shuffleBuffer;
            const gainNode = audioCtx.createGain();
            gainNode.gain.setValueAtTime(0.2, audioCtx.currentTime);
            gainNode.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + 2);
            source.connect(gainNode);
            gainNode.connect(audioCtx.destination);
            source.start(audioCtx.currentTime);
        }

        function setupAudio() {
            if (!audioCtx) {
                audioCtx = new (window.AudioContext || window.webkitAudioContext)();
                ambientMasterGain = audioCtx.createGain();
                ambientMasterGain.gain.setValueAtTime(1.0, audioCtx.currentTime);
                ambientMasterGain.connect(audioCtx.destination);
            }
            if (audioCtx.state === 'suspended') {
                audioCtx.resume();
            }
            if (!intervalId && !isMuted) {
                intervalId = setInterval(generarMelodia, 400);
            }
        }
        
        function toggleMute() {
            const muteBtn = document.getElementById('muteBtn');
            isMuted = !isMuted;
            if (isMuted) {
                if (intervalId) {
                    clearInterval(intervalId);
                    intervalId = null;
                }
                muteBtn.innerHTML = 'üîá Silenciar';
            } else {
                setupAudio();
                muteBtn.innerHTML = 'üîä Sonido';
            }
        }
        
        function tocarNota(frecuencia, duracion) {
            if (!audioCtx || isMuted || !ambientMasterGain) return;
            let oscillator = audioCtx.createOscillator();
            let gainNode = audioCtx.createGain();
            oscillator.type = 'triangle';
            oscillator.frequency.setValueAtTime(frecuencia, audioCtx.currentTime);
            let reverb = audioCtx.createDelay();
            reverb.delayTime.value = 0.2;
            oscillator.connect(reverb);
            reverb.connect(gainNode);
            
            gainNode.connect(ambientMasterGain); 
            
            gainNode.gain.setValueAtTime(0.08, audioCtx.currentTime);
            oscillator.start();
            oscillator.stop(audioCtx.currentTime + duracion);
        }

        function fadeAmbientVolume(targetVolume, duration) {
            if (ambientMasterGain && audioCtx) {
                const effectiveVolume = Math.max(0.001, targetVolume);
                ambientMasterGain.gain.exponentialRampToValueAtTime(effectiveVolume, audioCtx.currentTime + duration);
            }
        }
        
        function generarMelodia() {
            let nota = notas[Math.floor(Math.random() * notas.length)];
            tocarNota(nota, 0.6);
        }

        function createShootingStar() {
            const star = document.createElement('div');
            star.className = 'shooting-star';
            star.style.top = Math.random() * 100 + '%';
            star.style.left = '-100px';
            star.style.animationDuration = (Math.random() * 2 + 3) + 's';
            document.body.appendChild(star);
            setTimeout(() => {
                star.remove();
            }, 5000);
        }

        function generateStars() {
            const starsContainer = document.getElementById('stars');
            for (let i = 0; i < 100; i++) {
                const star = document.createElement('div');
                star.className = 'star';
                star.style.left = Math.random() * 100 + '%';
                star.style.top = Math.random() * 100 + '%';
                star.style.width = star.style.height = Math.random() * 3 + 1 + 'px';
                star.style.animationDelay = Math.random() * 2 + 's';
                starsContainer.appendChild(star);
            }
        }

        function generateParticles() {
            const particlesContainer = document.getElementById('particles');
            for (let i = 0; i < 20; i++) {
                const particle = document.createElement('div');
                particle.className = 'particle';
                particle.style.left = Math.random() * 100 + '%';
                particle.style.top = Math.random() * 100 + '%';
                particle.style.animationDelay = Math.random() * 3 + 's';
                particlesContainer.appendChild(particle);
            }
        }

        function createDeck(majorOnly = false) {
            let deck = [...MAJOR_ARCANA];
            if (!majorOnly) {
                Object.entries(SUITS).forEach(([suitName, suitData]) => {
                    for (let i = 1; i <= 10; i++) {
                        const cardName = i === 1 ? 'As' : i.toString();
                        deck.push({
                            name: `${cardName} de ${suitName}`,
                            symbol: suitData.symbol,
                            type: 'minor',
                            suit: suitName,
                            number: i
                        });
                    }
                    COURT_CARDS.forEach(courtCard => {
                        deck.push({
                            name: `${courtCard} de ${suitName}`,
                            symbol: suitData.symbol,
                            type: 'minor',
                            suit: suitName,
                            court: courtCard
                        });
                    });
                });
            }
            return deck;
        }

        function shuffleDeck(deck) {
            const shuffled = [...deck];
            for (let i = shuffled.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
            }
            return shuffled;
        }

        function getSpreadPositions(spreadType) {
            const positions = {
                1: ['Respuesta'],
                3: ['Pasado', 'Presente', 'Futuro'],
                5: ['Situaci√≥n actual', 'Desaf√≠o', 'Pasado', 'Futuro', 'Resultado'],
                10: ['Situaci√≥n actual', 'Desaf√≠o/Cruz', 'Pasado lejano', 'Futuro posible',
                     'Corona/Meta', 'Fundaci√≥n', 'Tu enfoque', 'Entorno externo',
                     'Esperanzas y miedos', 'Resultado final']
            };
            return positions[spreadType] || positions[1];
        }

        function createCardElement(card, position, index, isRevealed = false) {
            const cardEl = document.createElement('div');
            cardEl.className = 'card';

            if (card.type === 'major') {
                cardEl.classList.add('card--major-arcana');
            }

            cardEl.style.animationDelay = (index * 0.2) + 's';
            const isInverted = Math.random() < 0.5;
            card.inverted = isInverted;
            cardEl.innerHTML = `
                <div class="card-position">${position}</div>
                <div class="card-content">
                    <div class="card-name">${card.name}</div>
                    <div class="card-symbol">${card.symbol}</div>
                    <div class="card-orientation">${isInverted ? '(Invertida)' : '(Derecha)'}</div>
                </div>
            `;
            if (isInverted) {
                cardEl.classList.add('inverted');
            }
            if (!isRevealed) {
                cardEl.style.transform = 'rotateY(180deg)';
                cardEl.querySelector('.card-content').style.display = 'none';
            }
            cardEl.addEventListener('click', () => {
                if (cardEl.classList.contains('revealed')) {
                    cardEl.classList.add('spinning');
                    playClickSound(); 
                    setTimeout(() => {
                        cardEl.classList.remove('spinning');
                    }, 1000); 
                } else {
                    revealCard(cardEl, card);
                }
            });
            return cardEl;
        }

        function revealCard(cardEl, card) {
            cardEl.classList.add('flipping');
            cardEl.querySelector('.card-content').style.display = 'flex';
            playCardRevealSound();
            setTimeout(() => {
                cardEl.classList.add('revealed');
                cardEl.style.transform = card.inverted ? 'rotateY(0deg) rotate(180deg)' : 'rotateY(0deg)';
            }, 500);
        }

        async function startReading() {
            if (isReading) return;
            isReading = true;
            setupAudio();
            
            const shuffleBtn = document.getElementById('shuffleBtn');
            const deck = document.getElementById('deck');
            const shufflingContainer = document.getElementById('shuffling-container');
            const deckStatus = document.getElementById('deckStatus');
            const resultsDiv = document.getElementById('results');
            const exportBtn = document.getElementById('exportBtn');
            const ogreBubble = document.getElementById('ogre-interpretation');

            shuffleBtn.disabled = true;
            shuffleBtn.innerHTML = '<span class="loading"></span> Barajando...';
            deckStatus.textContent = 'Barajando las cartas...';
            resultsDiv.style.display = 'none';
            exportBtn.style.display = 'none';
            ogreBubble.style.display = 'none';

            playShuffleSound();

            deck.style.display = 'none';
            shufflingContainer.style.display = 'block';

            const numShufflingCards = 20;
            const shuffledCards = [];
            for(let i = 0; i < numShufflingCards; i++) {
                const card = document.createElement('div');
                card.className = 'shuffling-card';
                card.style.transform = `translate3d(0, 0, 0) rotateY(${Math.random() * 360}deg) rotateZ(${Math.random() * 360}deg)`;
                card.style.opacity = '0';
                shufflingContainer.appendChild(card);
                shuffledCards.push(card);
            }

            setTimeout(() => {
                shuffledCards.forEach(card => {
                    card.style.transform = `translate3d(${Math.random() * 300 - 150}px, ${Math.random() * 200 - 100}px, ${Math.random() * 200 - 100}px) rotateY(${Math.random() * 720 + 360}deg) rotateZ(${Math.random() * 720 + 360}deg)`;
                    card.style.opacity = '1';
                });
            }, 50);

            await new Promise(resolve => setTimeout(resolve, 1500));
            
            shuffledCards.forEach(card => {
                card.style.transform = `translate3d(0, 0, 0) rotateY(0deg) rotateZ(0deg)`;
                card.style.opacity = '0';
            });

            await new Promise(resolve => setTimeout(resolve, 1500));
            shuffledCards.forEach(card => card.remove());
            shufflingContainer.style.display = 'none';
            deck.style.display = 'block';

            deckStatus.textContent = 'Cortando el mazo...';
            
            const deckType = document.getElementById('deckType').value;
            const spreadType = parseInt(document.getElementById('spreadType').value);
            currentDeck = createDeck(deckType === 'major');
            currentDeck = shuffleDeck(currentDeck);
            
            await new Promise(resolve => setTimeout(resolve, 1000));
            
            deckStatus.textContent = 'Extrayendo cartas...';
            const cutPoint = Math.floor(Math.random() * currentDeck.length);
            currentDeck = [...currentDeck.slice(cutPoint), ...currentDeck.slice(0, cutPoint)];
            
            await new Promise(resolve => setTimeout(resolve, 1000));
            
            const positions = getSpreadPositions(spreadType);
            currentReading = [];
            for (let i = 0; i < positions.length; i++) {
                if (currentDeck.length > 0) {
                    currentReading.push({
                        card: currentDeck.pop(),
                        position: positions[i]
                    });
                }
            }
            displaySpread();
            shuffleBtn.disabled = false;
            shuffleBtn.innerHTML = 'üîÆ Nueva Tirada';
            deckStatus.textContent = 'Haz clic en las cartas para revelarlas...';
            isReading = false;
        }

        function getInterpretation(card, inverted) {
            let interpretation = "";
            if (card.type === 'major') {
                const data = INTERPRETATIONS[card.name];
                interpretation = inverted ? data.reversed : data.upright;
            } else {
                const minorSuit = MINOR_INTERPRETATIONS[card.suit];
                let cardKey = card.number ? (card.number === 1 ? 'As' : card.number.toString()) : card.court;
                if (minorSuit && minorSuit[cardKey]) {
                    const data = minorSuit[cardKey];
                    interpretation = inverted ? data.reversed : data.upright;
                } else {
                    interpretation = "No se encontr√≥ interpretaci√≥n para esta carta.";
                }
            }
            return interpretation;
        }

        function displaySpread() {
            const container = document.getElementById('spreadContainer');
            container.innerHTML = '';
            currentReading.forEach((reading, index) => {
                const cardEl = createCardElement(reading.card, reading.position, index);
                container.appendChild(cardEl);
                setTimeout(() => {
                    cardEl.style.animation = 'fadeInUp 0.6s ease-out forwards';
                }, index * 200);
            });
            setTimeout(() => {
                showAllCards();
            }, currentReading.length * 200 + 2000);
        }

        function showAllCards() {
            const cards = document.querySelectorAll('.card:not(.revealed)');
            cards.forEach((card, index) => {
                setTimeout(() => {
                    if (!card.classList.contains('revealed')) {
                        const cardData = currentReading[Array.from(card.parentNode.children).indexOf(card)];
                        revealCard(card, cardData.card);
                    }
                }, index * 300);
            });
            setTimeout(() => {
                showResults();
            }, cards.length * 300 + 1000);
        }
        
        function playOgreAnimation() {
            const ogreArea = document.querySelector('.ogre-area');
            const ogreImage = document.getElementById('ogre-image');
            if (!ogreImage) return;

            fadeAmbientVolume(0.2, 1.0);

            const ogreVideo = document.createElement('video');
            ogreVideo.src = 'Ogro.webm';
            ogreVideo.id = 'ogre-video';
            ogreVideo.autoplay = true;
            ogreVideo.muted = false;
            ogreVideo.playsInline = true;
            ogreVideo.style.maxWidth = '150px';
            ogreVideo.style.height = 'auto';

            ogreVideo.addEventListener('ended', () => {
                fadeAmbientVolume(1.0, 1.5);
                if (ogreVideo.parentNode) {
                    ogreArea.replaceChild(ogreImage, ogreVideo);
                }
            }, { once: true });
            
            ogreArea.replaceChild(ogreVideo, ogreImage);
            
            ogreVideo.play().catch(error => {
                 console.error("Error al reproducir el video del ogro:", error);
                 ogreArea.replaceChild(ogreImage, ogreVideo);
                 fadeAmbientVolume(1.0, 0.5);
            });
        }

        async function getOgreInterpretation(reading) {
            const ogreBubble = document.getElementById('ogre-interpretation');
            ogreBubble.style.display = 'block';
            ogreBubble.innerHTML = '<span class="loading"></span> El Ogro est√° consultando el cosmos...';
            
            playOgreAnimation();

            const readingSummary = reading.map(item => 
                `${item.position}: ${item.card.name} (${item.card.inverted ? 'Invertida' : 'Derecha'})`
            ).join(', ');

            const systemPrompt = "Act√∫a como un ogro m√≠stico, sabio, gru√±√≥n pero con un coraz√≥n de oro. Te llamas Grum. Interpreta la siguiente tirada de tarot de una forma muy coloquial, directa y con un toque de humor de ogro. lenguaje de tarotistaprofesional, s√© breve, no uses adjetivos de genero llama al lector al lector con sustantivos sin g√©nero como criatura humana o similares, no uses g√©nero ya que no sabemos si el lector ser√° hombre o mujer. no uses markdown, usa html para las negritas ya que tu texto se reproduce dentro de un index.html.";
            
            const userQuery = `Grum, mi tirada es: ${readingSummary}. ¬øQu√© ves t√∫, grandull√≥n?`;

            try {
                const payload = {
                    contents: [{ parts: [{ text: userQuery }] }],
                    systemInstruction: { parts: [{ text: systemPrompt }] },
                };

                const response = await fetch(PROXY_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    const errorBody = await response.text();
                    throw new Error(`Error de la API: ${response.status} ${response.statusText}. Detalles: ${errorBody}`);
                }

                const result = await response.json();
                const text = result.candidates?.[0]?.content?.parts?.[0]?.text;

                if (text) {
                    ogreBubble.innerHTML = text.replace(/\n/g, '<br>');
                } else {
                    ogreBubble.textContent = "Vaya, el cosmos est√° t√≠mido hoy. No logro ver nada claro.";
                }

            } catch (error) {
                console.error("Error al contactar con el Ogro:", error);
                ogreBubble.textContent = "¬°Argh! Mis visiones se han nublado. He realizado demasiadas predicciones seguidas, tendr√°s que conformarte con las indicaciones de abajo o probar m√°s tarde.";
            }
        }

        function showResults() {
            const resultsDiv = document.getElementById('results');
            const resultsContent = document.getElementById('resultsContent');
            const exportBtn = document.getElementById('exportBtn');
            let resultsHTML = '';
            currentReading.forEach((reading, index) => {
                const cardData = reading.card;
                const orientation = cardData.inverted ? 'invertida' : 'derecha';
                const fullInterpretation = getInterpretation(cardData, cardData.inverted);
                resultsHTML += `
                    <div class="result-item">
                        <h3>Carta ${index + 1} (${reading.position}):</h3>
                        <h4>${cardData.name} (${orientation})</h4>
                        <p>${fullInterpretation}</p>
                    </div>
                `;
            });
            resultsContent.innerHTML = resultsHTML;
            resultsDiv.style.display = 'block';
            exportBtn.style.display = 'inline-block';
            getOgreInterpretation(currentReading);
        }

        async function exportReading() {
            const exportBtn = document.getElementById('exportBtn');
            exportBtn.disabled = true;
            exportBtn.innerHTML = '<span class="loading"></span> Exportando...';
            const elementToCapture = document.getElementById('reading-snapshot');
            try {
                const canvas = await html2canvas(elementToCapture, {
                    backgroundColor: '#1e0c3a',
                    useCORS: true,
                    scale: 2
                });
                const link = document.createElement('a');
                link.download = 'mi-tirada-tarot-ogro.png';
                link.href = canvas.toDataURL('image/png');
                link.click();
            } catch (error) {
                console.error('Error al exportar la imagen:', error);
                alert('Hubo un problema al exportar la imagen.');
            } finally {
                 exportBtn.disabled = false;
                 exportBtn.innerHTML = 'üì∏ Exportar PNG';
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            generateStars();
            generateParticles();
            setInterval(createShootingStar, 7000);
            document.querySelectorAll('button, .deck').forEach(el => {
                el.addEventListener('click', playClickSound);
            });
            checkCookieConsent();
        });
    </script>
    
    <script>
        function loadGoogleAnalytics() {
            const script = document.createElement('script');
            script.async = true;
            script.src = 'https://www.googletagmanager.com/gtag/js?id=G-ZFDC8MXKCV';
            document.head.appendChild(script);

            script.onload = () => {
                window.dataLayer = window.dataLayer || [];
                function gtag(){dataLayer.push(arguments);}
                gtag('js', new Date());
                gtag('config', 'G-ZFDC8MXKCV', {
                    'page_title' : 'Tarot del Ogro azul',
                    'page_path': '/'
                });
                console.log('Google Analytics cargado.');
            }
        }
    </script>
</body>
</html>
